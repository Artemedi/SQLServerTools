# Служебная база обслуживания и мониторинга

База данных предоставляет набор служебных объектов для выполнения настраиваемых операций обслуживания и мониторинга.

- [Служебная база обслуживания и мониторинга](#служебная-база-обслуживания-и-мониторинга)
  - [Создание базы](#создание-базы)
  - [Доступные операции](#доступные-операции)
  - [Примеры использования](#примеры-использования)
    - [Сбор информации о размере таблиц](#сбор-информации-о-размере-таблиц)
    - [Сбор информации о состоянии объектов базы данных](#сбор-информации-о-состоянии-объектов-базы-данных)
    - [Обслуживание индексов](#обслуживание-индексов)
      - [Обслуживание индексов во всех базах](#обслуживание-индексов-во-всех-базах)
      - [Обслуживание индексов в конкретной базе](#обслуживание-индексов-в-конкретной-базе)
      - [Обслуживание индексов по конкретной таблице с учетом сохраненных данных о состоянии объектов](#обслуживание-индексов-по-конкретной-таблице-с-учетом-сохраненных-данных-о-состоянии-объектов)
      - [Логи обслуживания индексов](#логи-обслуживания-индексов)
    - [Обслуживание статистик](#обслуживание-статистик)
      - [Обновим статистику во всех базах](#обновим-статистику-во-всех-базах)
      - [Обновление статистики для конкретной базы полным сканированием](#обновление-статистики-для-конкретной-базы-полным-сканированием)
      - [Обновление статистики для конкретной таблицы](#обновление-статистики-для-конкретной-таблицы)
      - [Настройка приоритета и исключений для индексов](#настройка-приоритета-и-исключений-для-индексов)
      - [Логи обслуживания статистик](#логи-обслуживания-статистик)

Далее рассмотрим примеры работы с этой базой данных.

## Создание базы

Для создания нужно использовать [скрипт](CreateServiceDatabaseScript.sql), который создаст все необходимые таблицы для хранения логов обслуживания и другой информации, а также хранимые процедуры выполнения обслуживания и прочих действий.

## Доступные операции

Служебная база содержит следующие доступные операции:

- Обслуживание индексов
- Обслуживание  статистик
- Сбор информации о размерах таблиц баз данных на сервере

Кроме этого, все операции обслуживания логируются, что позволяет диагностировать их работу, находить узкие места и делать более гибкие настройки обслуживания.

Рассмотрим примеры работы с ними.

## Примеры использования

### Сбор информации о размере таблиц

Важно собирать информацию о динамике изменения размера таблиц баз данных на сервере. Для этого можно настроить задание с расписанием запуска 1 раз в сутки, вызывающий следующий скрипт:

```sql
EXECUTE [SQLServerMaintenance].[dbo].[sp_SaveDatabasesTablesStatistic]
```

В результате будет собрана подробная информация о размерах таблиц каждой базы на сервере. Результаты записываются в таблицу "DatabasesTablesStatistic". Вот пример данных:
               |
| Period                      | DatabaseName | SchemaName | TableName             | RowCnt   | Reserved | Data    | IndexSize | Unused |
| --------------------------- | ------------ | ---------- | --------------------- | -------- | -------- | ------- | --------- | ------ |
| 2022-01-03 10:31:36.1000000 | SomeDatabase     | dbo        | \_AccRgED9823          | 18917980 | 4461736  | 1645064 | 2816440   | 232    |
| 2022-01-03 10:31:36.1033333 | SomeDatabase     | dbo        | \_AccRg9786            | 4659752  | 3003232  | 1637968 | 1364824   | 440    |
| 2022-01-03 10:31:36.1033333 | SomeDatabase     | dbo        | \_AccRgAT92820         | 647989   | 327520   | 313936  | 9560      | 4024   |
| 2022-01-03 10:31:36.1033333 | SomeDatabase     | dbo        | \_AccRgAT93821         | 6251900  | 3011736  | 2957568 | 54112     | 56     |
| 2022-01-03 10:31:36.1033333 | SomeDatabase     | dbo        | \_Document9239\_VT95716 | 1278     | 264280   | 263832  | 120       | 328    |

Таблица содержит информацию о каждой таблице базы данных на определенную дату:

- Количество записей (RowCnt)
- Размер данных, КБ (Data)
- Размер индексов, КБ (IndexSize)
- Неиспользованное место, КБ (Unused)
- Места зарезервировано всего, КБ (Reserved). Reserved = Data + IndexSize + Unused.

### Сбор информации о состоянии объектов базы данных

Анализ состояния объектов базы перед обслуживанием можем быть дорогостоящей и долгой операцией. Эта функция позволяет предварительно сохранить сотояние объектов в служебную базу, а потом использовать эту информацию при запуске скриптов обслуживания. Или для анализа состояния базы и эффективности самого обслуживания.

```sql
EXECUTE [SQLServerMaintenance].[dbo].[sp_FillDatabaseObjectsState] 
   @databaseName = 'bsl_2_4_2'
```

Таблица **DatabaseObjectsState** с сохраненными данными содержит:

* Период сохранения записи
* Имя базы
* Имя таблицы
* Имя объекта (обычно индекса)
* Размер объекта в страницах (1 страница = 8 КБ)
* Количество измененных строк с момента последнего обслуживания статистики
* Средний процент фрагментации индекса
* Признак поддержки онлайн-перестроения индекса

В общем, применению этой информации место всегда можно найти.

### Сбор информации о соединения с базой данных

Процедура сохраняет срез всех соединения с базой данных в таблицу **ConnectionsStatistic** для последующего анализа.

```sql
EXECUTE [SQLServerMaintenance].[dbo].[sp_FillConnectionsStatistic]
```

Таблица **ConnectionsStatistic** с сохраненными данными содержит всю ту информацию, которая возвращается из системного объекта **[sys.dm_exec_requests](https://docs.microsoft.com/ru-ru/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-requests-transact-sql?view=sql-server-ver15)**.

### Обслуживание индексов

Для обслуживания индексов используется процедура "sp_IndexMaintenance", которая позволяет указать:

- Конкретную базу для обслуживания (databaseName)
- Интервал времени, в который доступна работа скрипта (timeFrom и timeTo)
- Режим обслуживания индексов (useOnlineIndexRebuild):

  - (0) - стандартное обслуживание
  - (1) - онлайн обслуживания и только для тех объектов, которые это поддерживают. Таблицы с устаревшими типами могут не поддерживать онлайн-перестроение и будут пропущены.
  - (2) - обслуживание только тех объектов, в которых онлайн-перестроение не поддерживается.
  - (3) - обслуживание индексов с онлайн-перестроением. Так где операция недоступна будет выполнено классическое перестроение индексов.

- Указать минимальный и максимальный размер индекса при обслуживании в количестве страниц (1 страница = 8 КБ, minIndexSizePages и maxIndexSizePages, по умолчанию не заданы)
- Минимальный размер процента фрагментации (fragmentationPercentMinForMaintenance, по умолчанию 10%)., с которого начинается обслуживание. Обычно это операция реорганизации, если процент не превышает процента, с которого начинается перестроение (по умолчанию 30%).
- Максимальный размер индекса в страницах, для которых может применяться операция реорганизации (maxIndexSizeForReorganizingPages). По умолчанию 50 ГБ, то есть 6553600 страниц. Все что большего размера будет использовать только перестроение индекса, чтобы процесс обслуживания не подвисал на долгое время.
- Максимальный размер фрагментации (fragmentationPercentForRebuild, по умолчанию 30%), с которого начинается перестроение (до этого операция реорганизации).
- Степень параллелизма, т.к. количество потоков для операции обслуживания (maxDop, по умолчанию 8)
- Параметры служебной базы данных:
  - Флаг использования служебной базы (useMonitoringDatabase, 0 - не используем, 1 - используем, по умолчанию 1)
  - Имя служебной базы данных (monitoringDatabaseName, по умолчанию "SQLServerMaintenance")
- Признак использования информации о стоянии объектов базы данных, сохраренных в служебной базе. Если этих данных нет, то будет выполнен анализ базы данных.
- Условие отбора по имени таблицы, чтобы выполнить точечное обслуживание.

Вот несколько простых примеров обслуживания индексов.

#### Обслуживание индексов во всех базах

Вот простой скрипт для обслуживания индексов во всех базах стандартным способом.

```sql
DECLARE @command varchar(max) 
SELECT @command = 
'USE [?]
EXECUTE [SQLServerMaintenance].[dbo].[sp_IndexMaintenance]
 @databaseName =''?''
'
EXEC sp_MSforeachdb @command
```

Другие параметры не указываются, т.к. значения по умолчанию для простых случаев подходят без изменений.

#### Обслуживание индексов в конкретной базе

Сделаем обслуживание для коркретной базы.

```sql
EXECUTE [SQLServerMaintenance].[dbo].[sp_IndexMaintenance] 
   @databaseName = 'bsl_2_4_2'
   -- Разрешаем запуск скрипта с 01:00:00 до 04:00:00
  ,@timeFrom = '01:00:00'
  ,@timeTo = '04:00:00'
   -- Убираем мин. процент фрагментации для обслуживания, чтобы
   -- скрипт обслуживал все индексы вне зависимости от фрагментации
  ,@fragmentationPercentMinForMaintenance = 0
   -- Переопределяем степень параллелизма на 4
  ,@maxDop = 4
   -- Включаем использвоание онлайн-перестроения где это возможно.
   -- Для объектов, где операция недоступна, будет использоваться стандартная операция перестроения
  ,@useOnlineIndexRebuild = 3
```

Этот вариант больше походит на реальную задачу настройки обслуживания.

#### Обслуживание индексов по конкретной таблице с учетом сохраненных данных о состоянии объектов

Добавим условие на обслуживание конкретной таблицы и использование, если есть, ранее сохраненной информации о состоянии объектов базы данных. Так мы избежим запуска анализа объектов базы данных "на горячую". Может пригодиться, если есть несколько запусков скриптов обслуживания и каждый раз анализировать состояния объектов нет смысла, а иногда и долго.

```sql
EXECUTE [SQLServerMaintenance].[dbo].[sp_IndexMaintenance] 
   @databaseName = 'bsl_2_4_2'
   -- Разрешаем запуск скрипта с 01:00:00 до 04:00:00
  ,@timeFrom = '01:00:00'
  ,@timeTo = '04:00:00'
   -- Убираем мин. процент фрагментации для обслуживания, чтобы
   -- скрипт обслуживал все индексы вне зависимости от фрагментации
  ,@fragmentationPercentMinForMaintenance = 0
   -- Переопределяем степень параллелизма на 4
  ,@maxDop = 4
   -- Включаем использвоание онлайн-перестроения где это возможно.
   -- Для объектов, где операция недоступна, будет использоваться стандартная операция перестроения
  ,@useOnlineIndexRebuild = 3,
  -- Использовать сохраненное состояние объектов из служебной базы
  ,@usePreparedInformationAboutObjectsStateIfExists = 1,
   -- Только индексы одной таблицы
  ,@ConditionTableName = 'LIKE ''_InfoRg1234'''
```

Своего рода точечное обслуживание для особых объектов.

#### Логи обслуживания индексов

Лог операций обслуживания индексов хранится в таблице "MaintenanceActionsLog" и имеет примерно такой вид.

| Id | Period           | TableName     | IndexName        | Operation     | RunDate          | StartDate        | FinishDate       | DatabaseName | UseOnlineRebuild | Comment | IndexFragmentation | RowModCtr | SQLCommand                                                                            |
| -- | ---------------- | ------------- | ---------------- | ------------- | ---------------- | ---------------- | ---------------- | ------------ | ---------------- | ------- | ------------------ | --------- | ------------------------------------------------------------------------------------- |
| 1  | 03.01.2022 11:36 | \_InfoRg931551 | \_InfoRg931551\_1 | REBUILD INDEX | 03.01.2022 11:36 | 03.01.2022 11:36 | 03.01.2022 11:36 | SomeDatabase     | 0                |         | 99                 | 0         | ALTER INDEX \[\_InfoRg931551\_1\] ON \[dbo\].\[\_InfoRg31551\] REBUILD WITH (MAXDOP=8) |
| 2  | 03.01.2022 11:36 | \_InfoRg931551 | \_InfoRg931551\_2 | REBUILD INDEX | 03.01.2022 11:36 | 03.01.2022 11:36 | 03.01.2022 11:36 | SomeDatabase     | 0                |         | 90                 | 0         | ALTER INDEX \[\_InfoRg931551\_2\] ON \[dbo\].\[\_InfoRg31551\] REBUILD WITH (MAXDOP=8) |
| 3  | 03.01.2022 11:36 | \_InfoRg929031 | \_InfoRg929031\_1 | REBUILD INDEX | 03.01.2022 11:36 | 03.01.2022 11:36 | 03.01.2022 11:36 | SomeDatabase     | 0                |         | 89                 | 0         | ALTER INDEX \[\_InfoRg929031\_1\] ON \[dbo\].\[\_InfoRg29031\] REBUILD WITH (MAXDOP=8) |
| 4  | 03.01.2022 11:36 | \_InfoRg929031 | \_InfoRg929031\_2 | REBUILD INDEX | 03.01.2022 11:36 | 03.01.2022 11:36 | 03.01.2022 11:36 | SomeDatabase     | 0                |         | 84                 | 0         | ALTER INDEX \[\_InfoRg929031\_2\] ON \[dbo\].\[\_InfoRg29031\] REBUILD WITH (MAXDOP=8) |
| 5  | 03.01.2022 11:36 | \_InfoRg929073 | \_InfoRg929073\_1 | REBUILD INDEX | 03.01.2022 11:36 | 03.01.2022 11:36 | 03.01.2022 11:36 | SomeDatabase     | 0                |         | 82                 | 0         | ALTER INDEX \[\_InfoRg929073\_1\] ON \[dbo\].\[\_InfoRg929073\] REBUILD WITH (MAXDOP=8) |

Лог содержит информацию:

- Период операции (Period)
- Имя таблицы (TableName)
- Имя индекса (IndexName)
- Имя операции. Для индексов это либо "REORGANIZE INDEX", либо "REBUILD INDEX" (Operation)
- Дата запуска обслуживания (RunDate)
- Дата старта (StartDate)
- Дата завершения. Если дата завершения NULL, то значит операция обслуживания не была завершена успешно (FinishDate)
- Имя базы (DatabaseName)
- Признак использования операции онлайн-перестроения индекса (UseOnlineRebuild)
- Произвольный комментарий, обычно заполняется при ошибках (Comment)
- Процент фрагментации индекса перед обслуживанием (IndexFragmentation)
- Количество измененных строк до обслуживания индекса (RowModCtr)
- SQL-команда обслуживания индекса (SQLCommand)

Лог позволяет определить эффективность обслуживания статистики и предпринять различные меры по ее актуализации.

### Обслуживание статистик

Для обслуживания объектов статистики используется процедура "sp_StatisticMaintenance", которая позволяет указать:

- Конкретную базу для обслуживания (databaseName)
- Интервал времени, в который доступна работа скрипта (timeFrom и timeTo)
- Режим обслуживания статистики (mode, 0 - по выборке, 1 - полное сканирование, по умолчанию 0) (по выборке данных или полным сканированием). Полное сканирование дает более точный результат, но может занять длительное время, в то время как анализ выборки данных значительно ускоряет этот процесс. [Подробнее здесь](https://docs.microsoft.com/ru-ru/sql/t-sql/statements/update-statistics-transact-sql?view=sql-server-ver15).
- Указать произвольное условие обслуживания на имя таблиц (если нужно настроить гибкое обслуживания по таблицам). (ConditionTableName, по умолчанию не используется)
- Параметры служебной базы данных:
  - Флаг использования служебной базы (useMonitoringDatabase, 0 - не используем, 1 - используем, по умолчанию 1)
  - Имя служебной базы данных (monitoringDatabaseName, по умолчанию "SQLServerMaintenance")

Вот несколько простых примеров.

#### Обновим статистику во всех базах

Следующий скрипт выполняет обновление статистики во всех базах на сервере по выборке данных.

```sql
DECLARE @command varchar(max) 
SELECT @command = 
'USE [?]
EXECUTE [SQLServerMaintenance].[dbo].[sp_StatisticMaintenance] 
   @databaseName =''?''
' 
EXEC sp_MSforeachdb @command
```

По умолчанию обновление выполняется в режиме выборки данных, поэтому скрипт отработает достаточно быстро.

#### Обновление статистики для конкретной базы полным сканированием

Настроим скрипт, который обновляет статистику полным сканированием в определенной базе данных, при этом разрешенное время работы скрипта с 02:00:00 до 03:00:00.

```sql
EXECUTE [SQLServerMaintenance].[dbo].[sp_StatisticMaintenance] 
   @databaseName = 'SomeDatabase'
  ,@timeFrom = '02:00:00'
  ,@timeTo = '03:00:00'
  ,@mode = 1 -- 0 устанавливаем режим анализа выборки данных, 1 - режим полного сканирования
```

#### Обновление статистики для конкретной таблицы

Иногда бывает необходимо выполнять обслуживание статистик для опредленной таблицы отдельно от основного обслуживания.

```sql
EXECUTE [SQLServerMaintenance].[dbo].[sp_StatisticMaintenance] 
   @databaseName = 'SomeDatabase'
  ,@mode = 1 -- 0 устанавливаем режим анализа выборки данных, 1 - режим полного сканирования
  ,@ConditionTableName = '= ''TestTable''' -- Условие на имя таблицы
GO
```

#### Настройка приоритета и исключений для индексов

В таблице "MaintenanceIndexPriority" можно настроить приоритеты и признак исключения обслуживания для индексов.

- Имя базы данных (DatabaseName)
- Имя таблицы (TableName)
- Имя индекса (IndexName)
- Приоритет (Priority). Если приоритет ниже или равен 10, то для индекса будет считаться критичным и к нему будет по возможности использоваться операция перестроения. Операция реорганизации не будет применена. При выборке индексов для обслуживания, порядок обслуживания будет в первую очередь определяться приоритетом, а только после количеством изменений для этого индекса.
- Исключен из обслуживания (Exclude). Если установить в 1, то индекс не будет обслуживаться.

#### Логи обслуживания статистик

Лог операций обслуживания статистики хранится в таблице "MaintenanceActionsLog" и имеет примерно такой вид.

|   | Id | Period           | TableName                     | IndexName                                          | Operation         | RunDate          | StartDate        | FinishDate       | DatabaseName | UseOnlineRebuild | Comment | IndexFragmentation | RowModCtr | SQLCommand                                                                                                         |
| - | -- | ---------------- | ----------------------------- | -------------------------------------------------- | ----------------- | ---------------- | ---------------- | ---------------- | ------------ | ---------------- | ------- | ------------------ | --------- | ------------------------------------------------------------------------------------------------------------------ |
| 1 | 1  | 03.01.2022 10:48 | service\_broker\_map          | I\_CLUST                                           | UPDATE STATISTICS | 03.01.2022 10:48 | 03.01.2022 10:48 | 03.01.2022 10:48 | tempdb       | 0                |         | 0                  | 129       | UPDATE STATISTICS \[sys\].\[service\_broker\_map\] \[I\_CLUST\]                                                    |
| 2 | 2  | 03.01.2022 10:48 | service\_broker\_map          | I\_SECONDARY                                       | UPDATE STATISTICS | 03.01.2022 10:48 | 03.01.2022 10:48 | 03.01.2022 10:48 | tempdb       | 0                |         | 0                  | 129       | UPDATE STATISTICS \[sys\].\[service\_broker\_map\] \[I\_SECONDARY\]                                                |
| 3 | 3  | 03.01.2022 10:48 | syscachedcredentials          | PK\_\_syscache\_\_F6D56B560A8C29D8                 | UPDATE STATISTICS | 03.01.2022 10:48 | 03.01.2022 10:48 | 03.01.2022 10:48 | msdb         | 0                |         | 0                  | 10638     | UPDATE STATISTICS \[dbo\].\[syscachedcredentials\] \[PK\_\_syscache\_\_F6D56B560A8C29D8\]                          |
| 4 | 4  | 03.01.2022 10:48 | syscachedcredentials          | \_WA\_Sys\_00000004\_01142BA1                      | UPDATE STATISTICS | 03.01.2022 10:48 | 03.01.2022 10:48 | 03.01.2022 10:48 | msdb         | 0                |         | 0                  | 393       | UPDATE STATISTICS \[dbo\].\[syscachedcredentials\] \[\_WA\_Sys\_00000004\_01142BA1\]                               |
| 5 | 5  | 03.01.2022 10:48 | syscollector\_blobs\_internal | PK\_syscollector\_blobs\_internal\_paremeter\_name | UPDATE STATISTICS | 03.01.2022 10:48 | 03.01.2022 10:48 | 03.01.2022 10:48 | msdb         | 0                |         | 0                  | 1         | UPDATE STATISTICS \[dbo\].\[syscollector\_blobs\_internal\] \[PK\_syscollector\_blobs\_internal\_paremeter\_name\] |

Лог содержит информацию:

- Период операции (Period)
- Имя таблицы (TableName)
- Имя индекса или имя служебной статистики, если не относится к индексу (IndexName)
- Имя операции. Для статистики это всегда "UPDATE STATISTICS" (Operation)
- Дата запуска обслуживания (RunDate)
- Дата старта (StartDate)
- Дата завершения. Если дата завершения NULL, то значит операция обслуживания не была завершена успешно (FinishDate)
- Имя базы (DatabaseName)
- Произвольный комментарий, обычно заполняется при ошибках (Comment)
- Количество измененных строк до обслуживания статистики (RowModCtr)
- SQL-команда обслуживания объекта статистики (SQLCommand)

Некоторые другие поля в логе обслуживания относятся к индексам и для обслуживания статистики не заполняются.

Лог позволяет определить эффективность обслуживания статистики и предпринять различные меры по ее актуализации.
